name: ec2-test
description: Deploy EC2 instance with web server and verify resources

working_dir: ./terraform/ec2/ec2   # relative or absolute path where terraform files live

environment:
  provider: aws
  # No credentials here â€” use existing AWS SDK defaults / env vars

steps:
  - name: init-and-plan
    type: terraform
    commands:
      - terraform init
      - terraform plan -out=plan.tfplan

  - name: apply
    type: terraform
    command: terraform apply -auto-approve plan.tfplan

  - name: inventory-check
    type: terraform-inventory
    after: apply
    expected:
      resources:
        - type: aws_vpc
          min_count: 1
          max_count: 1
        - type: aws_subnet
          min_count: 1
        - type: aws_internet_gateway
          min_count: 1
        - type: aws_instance
          min_count: 1
          max_count: 1
        - type: aws_security_group
          min_count: 1
    fail_on_extra: false  # Allow other resources (route tables, etc.)
    fail_on_missing: true

  - name: http-health-check
    type: http
    url: "${output.url}"   # Uses terraform output interpolation: http://<public_ip>:3000
    expected_status: 200
    retries: 8
    delay: 10s

  - name: destroy
    type: terraform
    command: terraform destroy -auto-approve
    when: always   # always, on-success, on-failure

reporting:
  output: ./reports/${module}/${name}-$(date +%Y%m%d-%H%M%S).html
  formats: [html, json]

