name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Fast unit tests - runs on every PR
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependencies: true
      
      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.out
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.out
          fail_ci_if_error: false

  # Build and validate - ensures code compiles and basic functionality works
  build-and-validate:
    name: Build & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependencies: true
      
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false
      
      - name: Build infratest
        run: |
          go build -o infratest .
          chmod +x infratest
          ./infratest --help
      
      - name: Validate YAML parsing
        run: |
          # Test that we can parse example flows
          ./infratest run examples/simple-vpc/flow.yaml --help || true
          ./infratest run examples/alb-ec2/flow.yaml --help || true
      
      - name: Test Terraform validation (dry-run)
        working-directory: examples/simple-vpc/terraform
        run: |
          terraform init -backend=false
          terraform validate
          terraform fmt -check || echo "Format check skipped"
          # Test plan without apply (no infrastructure needed)
          terraform plan -out=/dev/null || echo "Plan check completed"

  # Integration tests with LocalStack - only on main branch or manual trigger
  integration-tests:
    name: Integration Tests (LocalStack)
    runs-on: ubuntu-latest
    # Only run on main branch or if explicitly requested
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependencies: true
      
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false
      
      - name: Build infratest
        run: |
          go build -o infratest .
          chmod +x infratest
      
      - name: Start LocalStack
        run: |
          docker run -d \
            --name localstack \
            -p 4566:4566 \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -e SERVICES=ec2,s3,vpc,iam,sts,elbv2 \
            -e DEBUG=0 \
            -e PERSISTENCE=0 \
            -e DOCKER_HOST=unix:///var/run/docker.sock \
            -e SKIP_INFRA_DOWNLOADS=1 \
            localstack/localstack:latest
      
      - name: Wait for LocalStack to be ready
        run: |
          echo "Waiting for LocalStack to be ready..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -s http://localhost:4566/_localstack/health | grep -q '"status": "running"'; then
              echo "LocalStack is ready!"
              curl http://localhost:4566/_localstack/health
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts: LocalStack not ready yet, waiting 5 seconds..."
            sleep 5
          done
          echo "LocalStack failed to start after $max_attempts attempts"
          docker logs localstack --tail 50
          exit 1
      
      - name: Run infratest on simple-vpc example
        working-directory: examples/simple-vpc
        run: |
          mkdir -p reports/simple-vpc
          ../../infratest run flow.yaml --localstack --debug
        env:
          INFRATEST_DEBUG_ENV: "false"
      
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: |
            examples/simple-vpc/reports/**/*.html
            examples/simple-vpc/reports/**/*.json
          retention-days: 7
          if-no-files-found: warn
      
      - name: Show LocalStack logs on failure
        if: failure()
        run: |
          echo "LocalStack logs:"
          docker logs localstack --tail 100 || true
