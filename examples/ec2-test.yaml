name: ec2-test
description: Deploy EC2 instance with web server and verify resources

working_dir: ./terraform/ec2/ec2   # relative or absolute path where terraform files live

environment:
  provider: aws
  # No credentials here â€” use existing AWS SDK defaults / env vars

steps:
  - name: init-and-plan
    type: terraform
    commands:
      - terraform init
      - terraform plan -out=plan.tfplan

  - name: apply
    type: terraform
    command: terraform apply -auto-approve plan.tfplan

  - name: inventory-check
    type: terraform-inventory
    after: apply
    expected_resources:
      aws_vpc.this:
        count: 1
        attributes:
          cidr_block: "10.0.0.0/16"
          enable_dns_hostnames: true
          enable_dns_support: true
      aws_subnet.public:
        count: 1
        attributes:
          map_public_ip_on_launch: true
      aws_internet_gateway.this:
        count: 1
      aws_instance.web:
        count: 1
        attributes:
          associate_public_ip_address: true
      aws_security_group.web3000:
        count: 1
        attributes:
          name: "tf-sg-web3000"

  - name: http-health-check
    type: http
    url: "${output.url}"   # Uses terraform output interpolation: http://<public_ip>:3000
    expected_status: 200
    retries: 8
    delay: 10s

  - name: destroy
    type: terraform
    command: terraform destroy -auto-approve
    when: always   # always, on-success, on-failure

reporting:
  output: ./reports/${module}/${name}-$(date +%Y%m%d-%H%M%S).html
  formats: [html, json]

