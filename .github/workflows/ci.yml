name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Fast unit tests - runs on every PR
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependencies: true
      
      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.out
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.out
          fail_ci_if_error: false

  # Build and validate - ensures code compiles and basic functionality works
  build-and-validate:
    name: Build & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependencies: true
      
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false
      
      - name: Build infratest
        run: |
          go build -o infratest .
          chmod +x infratest
          ./infratest --help
      
      - name: Validate YAML parsing
        run: |
          # Test that we can parse example flows
          ./infratest run examples/simple-vpc/flow.yaml 2>&1 | head -10 || true
          ./infratest run examples/alb-ec2/flow.yaml 2>&1 | head -10 || true
      
      - name: Test Terraform validation (dry-run)
        working-directory: examples/simple-vpc/terraform
        run: |
          terraform init -backend=false
          terraform validate
          terraform fmt -check || echo "Format check skipped"
          # Test plan without apply (no infrastructure needed)
          terraform plan -out=/dev/null -refresh=false || echo "Plan check completed"
